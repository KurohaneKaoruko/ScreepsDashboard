name: Release

on:
  push:
    tags:
      - "v*"

jobs:
  verify-version:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Verify tag and project version match
        run: node scripts/release/verify-tag-version.mjs ${{ github.ref_name }}

  publish-desktop:
    needs: verify-version
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: ubuntu-22.04
            args: "--target x86_64-unknown-linux-gnu"
            allow_failure: false
          - platform: ubuntu-24.04-arm
            args: "--target aarch64-unknown-linux-gnu"
            allow_failure: true
          - platform: windows-latest
            args: "--target x86_64-pc-windows-msvc"
            allow_failure: false
          - platform: windows-latest
            args: "--target aarch64-pc-windows-msvc"
            allow_failure: false
          - platform: macos-latest
            args: "--target universal-apple-darwin"
            allow_failure: false
    continue-on-error: ${{ matrix.allow_failure }}
    runs-on: ${{ matrix.platform }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install Linux system dependencies
        if: startsWith(matrix.platform, 'ubuntu-')
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            libayatana-appindicator3-dev \
            librsvg2-dev \
            patchelf

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust target for Windows ARM64
        if: matrix.args == '--target aarch64-pc-windows-msvc'
        run: rustup target add aarch64-pc-windows-msvc

      - name: Add Rust targets for macOS universal
        if: matrix.args == '--target universal-apple-darwin'
        run: rustup target add aarch64-apple-darwin x86_64-apple-darwin

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Resolve release metadata
        id: release_meta
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          DEFAULT_TITLE="Screeps Dashboard ${TAG}"
          DEFAULT_BODY="Automated release for ${TAG}."
          TAG_TYPE="$(git for-each-ref --format='%(objecttype)' "refs/tags/${TAG}" | head -n1)"

          if [ "$TAG_TYPE" = "tag" ]; then
            TAG_SUBJECT="$(git for-each-ref --format='%(contents:subject)' "refs/tags/${TAG}" | head -n1)"
            TAG_BODY="$(git for-each-ref --format='%(contents:body)' "refs/tags/${TAG}")"
          else
            TAG_SUBJECT=""
            TAG_BODY=""
          fi

          RELEASE_TITLE="${TAG_SUBJECT:-$DEFAULT_TITLE}"
          if [ -n "${TAG_BODY//[[:space:]]/}" ]; then
            RELEASE_BODY="$TAG_BODY"
          else
            RELEASE_BODY="$DEFAULT_BODY"
          fi

          if [[ "$VERSION" == *-* ]]; then
            IS_PRERELEASE=true
          else
            IS_PRERELEASE=false
          fi

          {
            echo "release_name<<EOF"
            echo "$RELEASE_TITLE"
            echo "EOF"
            echo "release_body<<EOF"
            echo "$RELEASE_BODY"
            echo "EOF"
            echo "prerelease=$IS_PRERELEASE"
          } >> "$GITHUB_OUTPUT"

      - name: Build and publish installers
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: ${{ steps.release_meta.outputs.release_name }}
          releaseBody: ${{ steps.release_meta.outputs.release_body }}
          prerelease: ${{ steps.release_meta.outputs.prerelease }}
          releaseDraft: false
          args: ${{ matrix.args }}

  publish-android:
    needs: publish-desktop
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      NDK_VERSION: "26.3.11579264"
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust Android targets
        run: rustup target add aarch64-linux-android armv7-linux-androideabi x86_64-linux-android i686-linux-android

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Install Android SDK and NDK
        run: |
          sdkmanager "platform-tools" "platforms;android-36" "build-tools;36.0.0" "ndk;${NDK_VERSION}"
          yes | sdkmanager --licenses
          echo "NDK_HOME=${ANDROID_HOME}/ndk/${NDK_VERSION}" >> "$GITHUB_ENV"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build Android APK
        run: pnpm run package:target -- android-apk

      - name: Build Android AAB
        run: pnpm run package:target -- android-aab

      - name: Upload Android artifacts to release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            dist/android-apk/*.apk
            dist/android-aab/*.aab

  publish-ios:
    needs: publish-desktop
    runs-on: macos-latest
    continue-on-error: true
    permissions:
      contents: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Add Rust iOS targets
        run: rustup target add aarch64-apple-ios aarch64-apple-ios-sim x86_64-apple-ios

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Initialize iOS project (best effort)
        continue-on-error: true
        shell: bash
        run: |
          if [ ! -d "src-tauri/gen/apple" ]; then
            pnpm run tauri -- ios init
          fi

      - name: Build iOS bundle (best effort)
        continue-on-error: true
        run: pnpm run package:target -- ios

      - name: Prepare iOS artifacts
        id: ios_assets
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p dist/ios-upload
          shopt -s nullglob
          for item in dist/ios/*; do
            base="$(basename "$item")"
            if [ -d "$item" ]; then
              ditto -c -k --sequesterRsrc --keepParent "$item" "dist/ios-upload/${base}.zip"
            else
              cp "$item" "dist/ios-upload/${base}"
            fi
          done
          if compgen -G "dist/ios-upload/*" > /dev/null; then
            echo "has_assets=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_assets=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Upload iOS artifacts to release
        if: steps.ios_assets.outputs.has_assets == 'true'
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          files: dist/ios-upload/*
